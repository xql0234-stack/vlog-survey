import streamlit as st
import pandas as pd
import random
from datetime import datetime
import os
import gspread
from google.oauth2.service_account import Credentials

# -----------------------------
# é é¢è¨­å®š
# -----------------------------
st.set_page_config(page_title="æ—…éŠVlogå•å·æ¸¬é©—", layout="centered")

st.title("æ—…éŠ Vlog å…§å®¹é¢¨æ ¼èˆ‡ç”Ÿæ´»å‹æ…‹å•å·")

# -----------------------------
# å•å·èªªæ˜
# -----------------------------
st.markdown("""
æ‚¨å¥½ï¼š

æ„Ÿè¬æ‚¨æ’¥å†—å¡«å¯«æœ¬å•å·ã€‚æœ¬ç ”ç©¶æ—¨åœ¨æ¢è¨ä¸åŒç”Ÿæ´»å‹æ…‹çš„è§€çœ¾ï¼Œ
å°æ—…éŠ Vlog å½±ç‰‡å…§å®¹å½¢å¼åŠ YouTuber å€‹äººç‰¹è³ªçš„åå¥½å·®ç•°ã€‚

æœ¬å•å·æ¡åŒ¿åå¡«ç­”æ–¹å¼ï¼Œæ‰€æœ‰è³‡æ–™åƒ…ä¾›å­¸è¡“ç ”ç©¶ä½¿ç”¨ï¼Œ
ä¸æ¶‰åŠä»»ä½•å•†æ¥­ç”¨é€”ã€‚è«‹æ‚¨ä¾å€‹äººçœŸå¯¦æƒ³æ³•ä½œç­”ï¼Œ
å…§å®¹ç„¡å°éŒ¯ä¹‹åˆ†ï¼Œæ•¬è«‹æ”¾å¿ƒå¡«å¯«ã€‚

å¡«ç­”æµç¨‹åŒ…å«ç”Ÿæ´»å‹æ…‹æ¸¬é©—èˆ‡å½±ç‰‡è§€è³ï¼Œ
ç³»çµ±å°‡åˆ†é…å…©æ”¯æ—…éŠ Vlog å½±ç‰‡ï¼Œ
æ¯æ”¯å½±ç‰‡è§€çœ‹å®Œå¾Œï¼Œè«‹æ‚¨åˆ†åˆ¥å›ç­”ç›¸åŒçš„ä¸€çµ„é¡Œç›®ã€‚

ğŸ”¸ **æœ¬å•å·æ¡1ï½7åˆ†é‡è¡¨ï¼ˆ1ï¼éå¸¸ä¸åŒæ„ï¼Œ7ï¼éå¸¸åŒæ„ï¼‰ã€‚é¡Œç›®ä¸­çš„é¸é …åŠåˆå§‹æ•¸å­—åƒ…ç‚ºç³»çµ±é è¨­ï¼Œè«‹ä¾æ‚¨çš„å¯¦éš›æ„Ÿå—èª¿æ•´ä½œç­”ã€‚**

ğŸå¡«å•å·æŠ½æ˜Ÿå·´å…‹ç¦®åˆ¸ï¼  
ç‚ºæ„Ÿè¬æ‚¨çš„å”åŠ©ï¼Œå‡¡å®Œæˆæœ¬å•å·è€…å¯åƒåŠ æŠ½çï¼Œå°‡éš¨æ©ŸæŠ½å‡º**8ä½ç²å¾—æ˜Ÿå·´å…‹ç¦®åˆ¸ä¹™ä»½**ã€‚  
è‹¥é¡˜æ„åƒåŠ ï¼Œè«‹æ–¼å•å·æœ€å¾Œç•™ä¸‹ **é›»å­ä¿¡ç®±**ï¼ˆåƒ…ä½œä¸­çé€šçŸ¥ç”¨é€”ï¼Œä¸æœƒèˆ‡å•å·å…§å®¹é€£çµåˆ†æï¼‰ã€‚  

è‹¥æ‚¨å°æœ¬ç ”ç©¶æœ‰ä»»ä½•ç–‘å•ï¼Œæ­¡è¿èˆ‡ç ”ç©¶è€…è¯ç¹«ï¼š  
ä¸­åœ‹æ–‡åŒ–å¤§å­¸æ–°èå­¸ç³»ç ”ç©¶ç”Ÿè¨±ç§‹ç³  
ğŸ“§ é›»å­éƒµä»¶ï¼šxql0234@gmail.com

å†æ¬¡æ„Ÿè¬æ‚¨çš„å”åŠ©ï¼
""")

st.write("---")

# -----------------------------
# ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºæœ¬è³‡æ–™
# -----------------------------
st.header("ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºæœ¬è³‡æ–™")

watch_vlog = st.radio("1. éå»ä¸€å€‹æœˆæ˜¯å¦çœ‹éã€Œæ—…éŠç›¸é—œã€YouTubeå½±ç‰‡ï¼Ÿ", ["æ˜¯", "å¦"])
if watch_vlog == "å¦":
    st.info("æ„Ÿè¬æ‚¨çš„åƒèˆ‡ï¼Œæœ¬å•å·åˆ°æ­¤çµæŸ ğŸ™")
    st.stop()

watch_freq = st.radio("2. æ‚¨æ¯å‘¨å¹³å‡è§€çœ‹æ—…éŠVlogæ¬¡æ•¸ç‚ºï¼š", ["1~3æ¬¡", "4~6æ¬¡", "7~9æ¬¡", "10æ¬¡ä»¥ä¸Š"])
watch_time = st.radio("3. æ‚¨æ¯æ¬¡å¹³å‡è§€çœ‹æ—…éŠVlogæ‰€èŠ±è²»çš„æ™‚é–“ç‚ºï¼š", ["15åˆ†é˜ä»¥ä¸‹", "15~30åˆ†é˜", "30~45åˆ†é˜", "45åˆ†é˜ä»¥ä¸Š"])
gender = st.radio("4. æ‚¨çš„ç”Ÿç†æ€§åˆ¥ï¼š", ["ç”·", "å¥³"])
age_group = st.radio("5. æ‚¨çš„å¹´é½¡ï¼š", ["15~19æ­²", "20~29æ­²", "30~39æ­²", "40~49æ­²", "50~59æ­²", "60æ­²ä»¥ä¸Š"])
edu = st.radio("6. æ‚¨ç¾éšæ®µæœ€é«˜çš„æ•™è‚²ç¨‹åº¦ï¼š", ["åœ‹ä¸­(å«)ä»¥ä¸‹", "é«˜ä¸­(è·)", "å¤§å­¸(å°ˆ)", "ç ”ç©¶æ‰€(å«)ä»¥ä¸Š"])
job = st.selectbox("7. æ‚¨çš„è·æ¥­ï¼š", [
    "è¾²æ—æ¼ç‰§ç¤¦æ¥­",
    "è£½é€ æ¥­",
    "æœå‹™æ¥­",
    "è‡ªç”±æ¥­",
    "å•†æ¥­",
    "é›»å­è³‡è¨Šå·¥ç¨‹æ¥­",
    "æ–°èã€å‚³æ’­ã€å…¬é—œã€åª’é«”ç›¸é—œç”¢æ¥­",
    "å°ˆæ¥­äººå“¡ï¼ˆæ³•å¾‹ã€é†«ç™‚ã€è—è¡“è¡¨æ¼”ç­‰ï¼‰",
    "è»ã€è­¦ã€å…¬ã€æ•™",
    "å®¶ç®¡",
    "å­¸ç”Ÿ",
    "é€€ä¼‘ï¼å¾…æ¥­ä¸­ï¼ç„¡æ¥­",
    "å…¶ä»–"
])
income = st.selectbox("8. æ‚¨çš„æ¯æœˆå¯æ”¯é…æ‰€å¾—ï¼š", [
    "20,000å…ƒä»¥ä¸‹", "20,001~40,000å…ƒ", "40,001~60,000å…ƒ", "60,001~80,000å…ƒ",
    "80,001~100,000å…ƒ", "100,001~120,000å…ƒ", "120,001~140,000å…ƒ", "140,001~160,000å…ƒ",
    "160,001~180,000å…ƒ", "180,001~200,000å…ƒ", "200,001å…ƒä»¥ä¸Š"
])

# -----------------------------
# ç¬¬äºŒéƒ¨åˆ†ï¼šç”Ÿæ´»å‹æ…‹æ¸¬é©—
# -----------------------------
st.header("ç¬¬äºŒéƒ¨åˆ†ï¼šç”Ÿæ´»å‹æ…‹")

questions = {
    "æ¢ç´¢å†’éšªå‹": [
        "æˆ‘å–œæ­¡å˜—è©¦æ–°åœ°æ–¹èˆ‡ä¸ç†Ÿæ‚‰çš„æ´»å‹•ã€‚",
        "æˆ‘æœƒæœŸå¾…ç”Ÿæ´»ä¸­æœ‰äº›é©šå–œã€‚",
        "æˆ‘ä¸å–œæ­¡å¤ªæœ‰è¦å¾‹çš„ç”Ÿæ´»ã€‚",
        "æˆ‘äº«å—å…·æŒ‘æˆ°æ€§çš„æ—…éŠé«”é©—ã€‚"
    ],
    "ç¤¾äº¤åˆ†äº«å‹": [
        "æˆ‘å–œæ­¡åœ¨ç¤¾ç¾¤åª’é«”ä¸Šåˆ†äº«æˆ‘çš„æ—…éŠç¶“é©—æˆ–ç…§ç‰‡ã€‚",
        "æˆ‘æœƒé€éç¤¾ç¾¤å¹³å°è¿½è¹¤æ—…éŠYouTuberã€‚",
        "æˆ‘åƒåŠ æ—…éŠæ´»å‹•æ˜¯ç‚ºäº†è¯çµ¡é„°å±…æˆ–æœ‹å‹ä¹‹é–“çš„æ„Ÿæƒ…ã€‚",
        "æˆ‘å¸¸èˆ‡æœ‹å‹è¨è«–æ—…éŠ Vlog çš„å…§å®¹ï¼Œæˆ–äº¤æ›æ—…éŠè³‡è¨Šã€‚"
    ],
    "ä¼‘é–’æ”¾é¬†å‹": [
        "æˆ‘é‡è¦–ç”Ÿæ´»çš„æ­¥èª¿èˆ‡æ”¾é¬†ï¼Œä¸å–œæ­¡å¤ªåŒ†å¿™çš„æ—¥å­ã€‚",
        "æˆ‘å–œæ­¡åœ¨å‡æ—¥å®‰æ’ä¸€äº›è¼•é¬†çš„æ´»å‹•ï¼Œä¾‹å¦‚æ•£æ­¥ã€è½éŸ³æ¨‚æˆ–å–å’–å•¡ã€‚",
        "æˆ‘å–œæ­¡æ‚ é–’ã€ä¸ç·Šæ¹Šçš„æ—…éŠæ–¹å¼",
        "æˆ‘çœ‹æ—…éŠVlogå¤šåŠç‚ºäº†ç´“å£“ã€‚"
    ],
    "ç†æ€§è¦åŠƒå‹": [
        "æˆ‘ç¿’æ…£æ¯”è¼ƒåƒ¹æ ¼ã€è©•ä¼°æ€§åƒ¹æ¯”å¾Œå†æ±ºå®šã€‚",
        "æˆ‘æœƒåšå®Œæ•´è¡Œå‰åŠŸèª²èˆ‡æ™‚é–“è¦ç•«ã€‚",
        "æˆ‘åœ¨æ—…è¡Œæ™‚è¼ƒå°‘ä¾é éš¨èˆˆæˆ–è‡¨æ™‚æ±ºå®šã€‚",
        "æˆ‘æœƒå®šæœŸæœå°‹æ—…éŠç›¸é—œè³‡è¨Šã€‚"
    ]
}

responses = {}
question_num = 1
for category, qs in questions.items():
    for q in qs:
        question_label = f"{question_num}. {q}"
        responses[q] = st.slider(question_label, 1, 7, 4, key=q)
        question_num += 1

# -----------------------------
# å½±ç‰‡é€£çµè¨­å®š
# -----------------------------
videos = {
    "æ¢ç´¢å†’éšªå‹": "https://www.youtube.com/watch?v=rn3vkZf1NEw",
    "ç¤¾äº¤åˆ†äº«å‹": "https://www.youtube.com/watch?v=H_OVtdOKu8g",
    "ä¼‘é–’æ”¾é¬†å‹": "https://www.youtube.com/watch?v=xb8Va3qr62k",
    "ç†æ€§è¦åŠƒå‹": "https://www.youtube.com/watch?v=LpFSGtGw4X8"
}

# -----------------------------
# ç¬¬ä¸‰éƒ¨åˆ†ï¼šå½±ç‰‡è©•åƒ¹é¡Œé …
# -----------------------------
video_questions = [
    "æ—…éŠVlogä¸­çš„ç•«é¢å‘ˆç¾èˆ‡æ‹æ”æ‰‹æ³•æå‡äº†æˆ‘å°æ—…éŠåœ°é»çš„è‡¨å ´æ„Ÿã€‚",
    "æ—…éŠVlogçš„å‰ªè¼¯æ–¹å¼è®“æˆ‘è¦ºå¾—æµæš¢è‡ªç„¶ã€‚",
    "æˆ‘åå¥½ç•«è³ªé«˜ã€æ”å½±æŠ€è¡“ä½³çš„æ—…éŠVlogã€‚",
    "æ—…éŠVlogæä¾›çš„æ—…éŠè³‡è¨Šï¼ˆè¡Œç¨‹ã€äº¤é€šã€ä½å®¿ã€é ç®—ç­‰ï¼‰å°æˆ‘å¾ˆæœ‰å¹«åŠ©ã€‚",
    "å½±ç‰‡æä¾›çš„è³‡è¨Šã€å¯¦å‹™å»ºè­°æ¯”æ—…éŠæ›¸æˆ–ä¸€èˆ¬å®˜æ–¹è³‡è¨Šæ›´è²¼è¿‘å¯¦éš›æƒ…æ³ã€‚",
    "æˆ‘èƒ½å¾é€™æ”¯æ—…éŠVlogä¸­ç²å¾—æ—…ç¨‹è¦åŠƒçš„éˆæ„Ÿã€‚",
    "å½±ç‰‡çš„ç¯€å¥èˆ‡æƒ…ç·’é‹ªé™³èƒ½å¸å¼•æˆ‘æŒçºŒè§€çœ‹ã€‚",
    "å‰µä½œè€…åœ¨å½±ç‰‡ä¸­çš„è¡¨é”æ–¹å¼ï¼ˆå¦‚å£èªæ•˜è¿°ã€æ—ç™½æˆ–æƒ…æ„Ÿåˆ†äº«ï¼‰èƒ½è®“æˆ‘æŠ•å…¥å…¶ä¸­ã€‚",
    "å½±ç‰‡ä¸­å‰µä½œè€…çš„æ—…ç¨‹ç¶“æ­·èˆ‡å¿ƒå¢ƒè®ŠåŒ–ï¼Œè®“æˆ‘æ„Ÿåˆ°å…±é³´ã€‚",
    "è§€çœ‹å®Œæ­¤å½±ç‰‡èƒ½è®“æˆ‘æ„Ÿåˆ°æ„‰å¿«ã€æ”¾é¬†ã€‚",
    "å½±ç‰‡ä¸­çš„è¶£å‘³è¨­è¨ˆèƒ½è®“æˆ‘æŒçºŒæƒ³çœ‹ä¸‹å»",
    "è§€çœ‹å®Œå½±ç‰‡æœƒè®“æˆ‘æ›´æƒ³å»æ—…è¡Œã€‚"
]

youtuber_questions = [
    "æˆ‘å¯ä»¥ä¿¡ä»»é€™ä½YouTuberæ‰€æä¾›çš„æ—…éŠè³‡è¨Šã€‚",
    "æˆ‘è¦ºå¾—é€™ä½YouTuberçš„å½¢è±¡æ˜¯æ­£é¢çš„ã€‚",
    "æˆ‘èªç‚ºé€™ä½YouTuberå°æ—…éŠç›¸é—œçŸ¥è­˜å¾ˆç†Ÿæ‚‰ã€‚",
    "é€™ä½YouTuberæä¾›çš„å»ºè­°å…·å°ˆæ¥­åˆ¤æ–·æˆ–ç¶“é©—ç´¯ç©ã€‚",
    "æˆ‘èªç‚ºé€™ä½YouTuberçš„å¤–å‹æ˜¯å…·æœ‰å¸å¼•åŠ›çš„ã€‚",
    "æˆ‘è¦ºå¾—é€™ä½YouTuberå…·æœ‰å€‹äººç‰¹è‰²ã€é¢¨æ ¼é®®æ˜ã€‚",
    "æˆ‘èªç‚ºå¯ä»¥é€éæ—…éŠVlogäº†è§£é€™ä½YouTuberã€‚",
    "é€™ä½YouTubeä¸æ™‚æœƒåˆ†äº«å€‹äººå–œå¥½æˆ–æåˆ°éå»çš„ç”Ÿæ´»ç¶“æ­·ã€‚ã€‚",
]

# -----------------------------
# æäº¤ç”Ÿæ´»å‹æ…‹æ¸¬é©—
# -----------------------------
if st.button("æäº¤ç”Ÿæ´»å‹æ…‹æ¸¬é©—"):
    category_scores = {cat: sum(responses[q] for q in qs) for cat, qs in questions.items()}
    lifestyle = max(category_scores, key=category_scores.get)
    matched_video = videos[lifestyle]
    other_videos = [v for k, v in videos.items() if k != lifestyle]
    random_video = random.choice(other_videos)

    st.session_state["lifestyle"] = lifestyle
    st.session_state["category_scores"] = category_scores
    st.session_state["matched_video"] = matched_video
    st.session_state["random_video"] = random_video

    st.success(f"ä½ çš„ç”Ÿæ´»å‹æ…‹ç‚ºï¼š**{lifestyle}** ğŸ‰")

# -----------------------------
# è‹¥å·²å®Œæˆç”Ÿæ´»å‹æ…‹æ¸¬é©—ï¼Œé¡¯ç¤ºå½±ç‰‡èˆ‡ç¬¬äºŒéƒ¨åˆ†
# -----------------------------
if "lifestyle" in st.session_state:
    lifestyle = st.session_state["lifestyle"]
    matched_video = st.session_state["matched_video"]
    random_video = st.session_state["random_video"]

    st.header("ç¬¬ä¸‰éƒ¨åˆ†ï¼šå½±ç‰‡é¡Œ")
    st.markdown("### ğŸ“º ç¬¬ä¸€æ”¯å½±ç‰‡")
    st.video(matched_video)
    st.write("è«‹è§€çœ‹å½±ç‰‡å¾Œå›ç­”ä»¥ä¸‹é¡Œç›®ï¼š")

    matched_scores = {}
    for i, q in enumerate(video_questions + youtuber_questions, start=10):
        matched_scores[f"å½±ç‰‡1_Q{i}"] = st.slider(f"{i}. {q}", 1, 7, 4, key=f"mv1_{i}")

    st.markdown("---")

    st.markdown("### ğŸ¬ ç¬¬äºŒæ”¯å½±ç‰‡")
    st.video(random_video)
    st.write("è«‹è§€çœ‹å½±ç‰‡å¾Œå›ç­”ä»¥ä¸‹é¡Œç›®ï¼š")

    random_scores = {}
    for i, q in enumerate(video_questions + youtuber_questions, start=10):
        random_scores[f"å½±ç‰‡2_Q{i}"] = st.slider(f"{i}. {q}", 1, 7, 4, key=f"mv2_{i}")
    
    # ğŸ”¸ æŠ½çç”¨ Email é¡Œé …
    st.markdown("### ğŸ æŠ½çè¯çµ¡æ–¹å¼")
    email = st.text_input(
    "è‹¥é¡˜æ„åƒåŠ æ˜Ÿå·´å…‹ç¦®åˆ¸æŠ½çï¼Œè«‹ç•™ä¸‹æ‚¨çš„é›»å­ä¿¡ç®±ï¼ˆåƒ…ä½œä¸­çé€šçŸ¥ç”¨é€”ï¼Œä¸æœƒèˆ‡å•å·å…§å®¹é€£çµåˆ†æï¼‰ï¼š",
    ""
)
    # -----------------------------
    # æäº¤æ•´ä»½å•å·ï¼ˆç¨ç«‹å€å¡Šï¼‰
    # -----------------------------
    if st.button("æäº¤æ•´ä»½å•å·"):
        import gspread
        from google.oauth2.service_account import Credentials

        scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]

        creds = Credentials.from_service_account_info(
            st.secrets["gcp_service_account"],
            scopes=scope
        )

        client = gspread.authorize(creds)
        sheet = client.open_by_key("1njEcj_--KhiQffroDRrRsQT04hADYrK2Je-emcx-zPY").sheet1

        data_list = [
            datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            watch_vlog,
            watch_freq,
            watch_time,
            gender,
            age_group,
            edu,
            job,
            income,
            lifestyle,
            *st.session_state["category_scores"].values(),
            matched_video,
            random_video,
            *matched_scores.values(),
            *random_scores.values(),
            email
        ]

        sheet.append_row(data_list, value_input_option="USER_ENTERED")
        st.success("âœ… å•å·çµæœå·²æˆåŠŸå„²å­˜åˆ° Google è©¦ç®—è¡¨ï¼æ„Ÿè¬æ‚¨çš„å”åŠ© ğŸ™")












